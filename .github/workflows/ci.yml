name: CI/CD Pipeline

# Pipeline triggers: runs on every push and pull request
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Stage 1: Build - Install dependencies and verify build
  build:
    name: Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Verify build
        working-directory: ./backend
        run: |
          echo "Build verification: Checking if server.js is valid..."
          node -c server.js && echo "✅ Build verification complete"

  # Stage 2: Test - Run all test suites
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run unit tests
        working-directory: ./backend
        run: npm run test:unit
      
      - name: Run integration tests
        working-directory: ./backend
        run: npm run test:integration
      
      - name: Run system tests
        working-directory: ./backend
        run: npm run test:system
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: backend/test-results.json
          if-no-files-found: ignore

  # Stage 3: Coverage - Generate code coverage report
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Generate coverage report
        working-directory: ./backend
        run: npm run test:coverage
        continue-on-error: true
      
      - name: Check coverage threshold
        working-directory: ./backend
        run: npm run test:coverage:check || (echo "Coverage below 75% threshold" && exit 1)
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/coverage/
          retention-days: 30
      
      - name: Coverage comment (PR only)
        if: github.event_name == 'pull_request'
        uses: py-cov-action/python-coverage-comment-action@v3
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIMUM_GREEN: 75
          MINIMUM_ORANGE: 65

  # Stage 4: Lint - Static code analysis
  lint:
    name: Lint
    runs-on: ubuntu-latest
    needs: coverage
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run ESLint
        working-directory: ./backend
        run: npm run lint
        continue-on-error: true
      
      - name: Generate lint report
        working-directory: ./backend
        run: npm run lint > lint-report.txt 2>&1 || true
      
      - name: Upload lint report
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: backend/lint-report.txt
          retention-days: 30
      
      - name: Check lint score
        working-directory: ./backend
        run: |
          echo "Running ESLint..."
          LINT_OUTPUT=$(npm run lint 2>&1 || true)
          echo "$LINT_OUTPUT"
          
          # Count errors and warnings from ESLint output
          ERROR_COUNT=$(echo "$LINT_OUTPUT" | grep -oE "[0-9]+ error" | head -1 | grep -oE "[0-9]+" || echo "0")
          WARNING_COUNT=$(echo "$LINT_OUTPUT" | grep -oE "[0-9]+ warning" | head -1 | grep -oE "[0-9]+" || echo "0")
          
          # Set defaults if empty
          ERROR_COUNT=${ERROR_COUNT:-0}
          WARNING_COUNT=${WARNING_COUNT:-0}
          
          # Calculate lint score: 10 - (errors * 1.0) - (warnings * 0.5)
          # Using awk for floating point calculation
          LINT_SCORE=$(awk "BEGIN {printf \"%.2f\", 10 - ($ERROR_COUNT * 1.0) - ($WARNING_COUNT * 0.5)}")
          
          echo ""
          echo "=== Lint Score Calculation ==="
          echo "Errors: $ERROR_COUNT"
          echo "Warnings: $WARNING_COUNT"
          echo "Lint Score: $LINT_SCORE (out of 10.0)"
          echo "Threshold: ≥7.5"
          echo ""
          
          # Check if score is above 7.5 using awk
          SCORE_CHECK=$(awk "BEGIN {print ($LINT_SCORE >= 7.5) ? 1 : 0}")
          if [ "$SCORE_CHECK" -eq "0" ]; then
            echo "❌ Lint score ($LINT_SCORE) is below 7.5 threshold"
            exit 1
          else
            echo "✅ Lint score ($LINT_SCORE) meets threshold (≥7.5)"
          fi

  # Stage 5: Security - Vulnerability scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: ./backend
        run: npm ci
      
      - name: Run security audit
        working-directory: ./backend
        run: npm run security:check
        continue-on-error: true
      
      - name: Generate security report
        working-directory: ./backend
        run: npm audit --json > security-report.json 2>&1 || true
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: backend/security-report.json
          retention-days: 30
      
      - name: Check for critical vulnerabilities
        working-directory: ./backend
        run: |
          if npm audit --audit-level=high 2>&1 | grep -q "found.*high\|found.*critical"; then
            echo "Critical or high severity vulnerabilities found"
            npm audit --audit-level=high
            exit 1
          fi
          echo "No critical vulnerabilities found"

  # Stage 6: Deploy - Create deployment artifact
  deploy:
    name: Deploy Artifact
    runs-on: ubuntu-latest
    needs: [build, test, coverage, lint, security]
    if: github.ref == 'refs/heads/main' || github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.19.0'
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
      
      - name: Create deployment directory
        run: |
          mkdir -p deployment/backend
          mkdir -p deployment/backend/reports
      
      - name: Copy source code
        run: |
          cp -r backend/* deployment/backend/
          rm -rf deployment/backend/node_modules
          rm -rf deployment/backend/coverage
      
      - name: Copy reports
        run: |
          if [ -d "artifacts/coverage-report" ]; then
            cp -r artifacts/coverage-report deployment/backend/reports/coverage
          fi
          if [ -f "artifacts/lint-report/lint-report.txt" ]; then
            cp artifacts/lint-report/lint-report.txt deployment/backend/reports/
          fi
          if [ -f "artifacts/security-report/security-report.json" ]; then
            cp artifacts/security-report/security-report.json deployment/backend/reports/
          fi
      
      - name: Copy documentation
        run: |
          if [ -f "backend/README.md" ]; then
            cp backend/README.md deployment/backend/
          fi
          if [ -f "README.md" ]; then
            cp README.md deployment/
          fi
      
      - name: Create deployment package
        run: |
          cd deployment
          zip -r ../deployment-package-$(date +%Y%m%d-%H%M%S).zip .
          cd ..
      
      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deployment-package-*.zip
          retention-days: 30
      
      - name: Display artifact info
        run: |
          echo "Deployment artifact created successfully"
          ls -lh deployment-package-*.zip

